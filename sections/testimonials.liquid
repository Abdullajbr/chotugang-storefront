{% if section.settings.divider %}<div class="section--divider">{% endif %}

<div
  class="page-width testimonials-section text-{{ section.settings.align_text }}"
  data-section-id="{{ section.id }}"
  data-section-type="testimonials"
  style="background-color: {{ section.settings.section_bg_color }};">
  {% if section.settings.title != blank %}
    <div class="section-header">
      <h2>{{ section.settings.title | escape }}</h2>
      {% if section.settings.subtitle != blank %}
        <div class="testimonials-subtitle">{{ section.settings.subtitle }}</div>
      {% endif %}
    </div>
  {% endif %}

  {% if section.blocks.size > 0 %}
    <div class="testimonials-wrapper">
      <div class="testimonials-slider" id="Testimonials-{{ section.id }}" data-count="{{ section.blocks.size }}">
        {% for block in section.blocks %}
          <div
            class="testimonials-slide--{{ block.id }}"
            {{ block.shopify_attributes }}>
            <div class="testimonial-card" style="background-color: {{ block.settings.card_bg_color }}; color: {{ block.settings.card_text_color }};">
              <div class="testimonial-card__inner">
                <div class="testimonial-card__top">
                  {% if block.settings.image != blank %}
                    <div class="testimonial-card__image-container">
                      {%- assign img_url = block.settings.image | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
                      <img class="testimonial-card__image lazyload"
                          data-src="{{ img_url }}"
                          data-widths="[120, 180, 240]"
                          data-aspectratio="{{ block.settings.image.aspect_ratio }}"
                          data-sizes="auto"
                          alt="{{ block.settings.image.alt }}">
                      <noscript>
                        <img class="testimonial-card__image lazyloaded" src="{{ block.settings.image | img_url: '180x' }}" alt="{{ block.settings.image.alt }}">
                      </noscript>
                    </div>
                  {% endif %}
                  
                  <div class="testimonial-card__author-info">
                    {% if block.settings.author != blank %}
                      <div class="testimonial-card__author">{{ block.settings.author | escape }}</div>
                    {% endif %}
                    {% if block.settings.author_info != blank %}
                      <div class="testimonial-card__author-title">{{ block.settings.author_info | escape }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="testimonial-card__quote-icon">{% include 'icon-quote' %}</div>
                
                {% if block.settings.testimonial != blank %}
                  <div class="testimonial-card__content">{{ block.settings.testimonial }}</div>
                {% endif %}
                
                {% if block.settings.rating > 0 %}
                  <div class="testimonial-card__rating">
                    {% for i in (1..5) %}
                      {% if i <= block.settings.rating %}
                        <span class="testimonial-card__star testimonial-card__star--filled">★</span>
                      {% else %}
                        <span class="testimonial-card__star">★</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      {% if section.settings.show_navigation %}
        <div class="testimonials-slider__controls">
          <button class="testimonials-slider__prev" aria-label="Previous testimonial">
            <svg aria-hidden="true" focusable="false" role="presentation" width="20" height="20" viewBox="0 0 20 20">
              <path d="M17 9H5.83l3.58-3.59L8 4l-6 6 6 6 1.41-1.41L5.83 11H17z" fill="currentColor"/>
            </svg>
          </button>
          <button class="testimonials-slider__next" aria-label="Next testimonial">
            <svg aria-hidden="true" focusable="false" role="presentation" width="20" height="20" viewBox="0 0 20 20">
              <path d="M3 9h11.17l-3.58-3.59L12 4l6 6-6 6-1.41-1.41L14.17 11H3z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

{% if section.settings.divider %}</div>{% endif %}

<style>
  .testimonials-section {
    padding: 50px 0;
    transition: background-color 0.3s ease;
  }
  
  .testimonials-subtitle {
    margin-top: 10px;
    font-size: 16px;
    opacity: 0.8;
  }
  
  .testimonials-wrapper {
    position: relative;
    margin-top: 40px;
  }
  
  .testimonials-slider {
    display: flex;
    flex-wrap: nowrap;
    overflow: hidden;
    margin: 0 -15px;
  }
  
  .testimonial-card {
    height: 100%;
    margin: 15px;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
  }
  
  .testimonial-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
  }
  
  .testimonial-card__inner {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .testimonial-card__top {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .testimonial-card__image-container {
    width: 70px;
    height: 70px;
    flex-shrink: 0;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    border: 2px solid rgba(0, 0, 0, 0.05);
  }
  
  .testimonial-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .testimonial-card__author-info {
    flex-grow: 1;
  }
  
  .testimonial-card__author {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 4px;
  }
  
  .testimonial-card__author-title {
    font-size: 14px;
    opacity: 0.7;
  }
  
  .testimonial-card__quote-icon {
    margin-bottom: 15px;
    color: {{ section.settings.quote_color }};
    opacity: 0.3;
  }
  
  .testimonial-card__content {
    flex-grow: 1;
    margin-bottom: 15px;
    line-height: 1.6;
  }
  
  .testimonial-card__rating {
    font-size: 18px;
    margin-top: auto;
  }
  
  .testimonial-card__star {
    color: #ccc;
  }
  
  .testimonial-card__star--filled {
    color: {{ section.settings.star_color }};
  }
  
  .testimonials-slider__controls {
    display: flex;
    justify-content: center;
    margin-top: 30px;
    gap: 10px;
  }
  
  .testimonials-slider__prev,
  .testimonials-slider__next {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background-color: {{ section.settings.nav_bg_color }};
    color: {{ section.settings.nav_text_color }};
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .testimonials-slider__prev:hover,
  .testimonials-slider__next:hover {
    background-color: {{ section.settings.nav_bg_color | color_darken: 10 }};
  }
  
  @media screen and (max-width: 768px) {
    .testimonials-section {
      padding: 40px 0;
    }
    
    .testimonial-card {
      padding: 20px;
      margin: 10px;
    }
    
    .testimonial-card__top {
      flex-direction: column;
      text-align: center;
    }
    
    .testimonial-card__image-container {
      margin-right: 0;
      margin-bottom: 15px;
    }
    
    .testimonial-card__content {
      font-size: 14px;
    }
  }
  
  @media screen and (min-width: 769px) {
    .slick-slide {
      padding: 0 10px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    initTestimonialsSlider();
  });
  
  function initTestimonialsSlider() {
    var sliders = document.querySelectorAll('.testimonials-slider');
    
    sliders.forEach(function(slider) {
      var sliderId = slider.getAttribute('id');
      var slideCount = parseInt(slider.getAttribute('data-count'), 10);
      var slidesToShow = slideCount > 3 ? 3 : slideCount;
      
      var $slider = $('#' + sliderId);
      var $prevBtn = $slider.siblings('.testimonials-slider__controls').find('.testimonials-slider__prev');
      var $nextBtn = $slider.siblings('.testimonials-slider__controls').find('.testimonials-slider__next');
      
      $slider.slick({
        slidesToShow: slidesToShow,
        slidesToScroll: 1,
        arrows: false,
        dots: false,
        infinite: true,
        autoplay: true,
        autoplaySpeed: 5000,
        cssEase: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
        speed: 500,
        adaptiveHeight: false,
        responsive: [
          {
            breakpoint: 1024,
            settings: {
              slidesToShow: slideCount > 2 ? 2 : slideCount,
            }
          },
          {
            breakpoint: 768,
            settings: {
              slidesToShow: 1,
              adaptiveHeight: true
            }
          }
        ]
      });
      
      // Custom navigation
      $prevBtn.on('click', function() {
        $slider.slick('slickPrev');
      });
      
      $nextBtn.on('click', function() {
        $slider.slick('slickNext');
      });
    });
  }
  
  // Re-initialize when the section is reloaded in the editor
  if (Shopify.designMode) {
    document.addEventListener('shopify:section:load', function(event) {
      if (event.detail.sectionId.indexOf('testimonials') !== -1) {
        initTestimonialsSlider();
      }
    });
  }
</script>

{% schema %}
  {
    "name": "Testimonials",
    "class": "index-section",
    "max_blocks": 12,
    "settings": [
      {
        "type": "text",
        "id": "title",
        "label": "Heading",
        "default": "Testimonials"
      },
      {
        "type": "text",
        "id": "subtitle",
        "label": "Subtitle",
        "default": "What our customers are saying"
      },
      {
        "type": "select",
        "id": "align_text",
        "label": "Text alignment",
        "default": "center",
        "options": [
          {
            "value": "left",
            "label": "Left"
          },
          {
            "value": "center",
            "label": "Centered"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "show_navigation",
        "label": "Show navigation arrows",
        "default": true
      },
      {
        "type": "color",
        "id": "section_bg_color",
        "label": "Section background",
        "default": "#ffffff"
      },
      {
        "type": "color",
        "id": "quote_color",
        "label": "Quote icon color",
        "default": "#000000"
      },
      {
        "type": "color",
        "id": "star_color",
        "label": "Star rating color",
        "default": "#ffc107"
      },
      {
        "type": "color",
        "id": "nav_bg_color",
        "label": "Navigation background",
        "default": "#f5f5f5"
      },
      {
        "type": "color",
        "id": "nav_text_color",
        "label": "Navigation icon color",
        "default": "#000000"
      },
      {
        "type": "checkbox",
        "id": "divider",
        "label": "Show section divider",
        "default": false
      }
    ],
    "blocks": [
      {
        "type": "testimonial",
        "name": "Testimonial",
        "settings": [
          {
            "type": "image_picker",
            "id": "image",
            "label": "Author's image"
          },
          {
            "type": "text",
            "id": "author",
            "label": "Author",
            "default": "John Smith"
          },
          {
            "type": "text",
            "id": "author_info",
            "label": "Author info",
            "default": "Happy Customer"
          },
          {
            "type": "richtext",
            "id": "testimonial",
            "label": "Testimonial",
            "default": "<p>Add customer reviews and testimonials to showcase your store's happy customers.</p>"
          },
          {
            "type": "range",
            "id": "rating",
            "min": 0,
            "max": 5,
            "step": 1,
            "label": "Rating (0 = no stars)",
            "default": 5
          },
          {
            "type": "color",
            "id": "card_bg_color",
            "label": "Card background",
            "default": "#ffffff"
          },
          {
            "type": "color",
            "id": "card_text_color",
            "label": "Card text color",
            "default": "#333333"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Testimonials",
        "category": "Text",
        "blocks": [
          {
            "type": "testimonial"
          },
          {
            "type": "testimonial"
          },
          {
            "type": "testimonial"
          }
        ]
      }
    ]
  }
{% endschema %}