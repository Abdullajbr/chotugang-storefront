<div class="page-width">
  {% if section.settings.title != blank %}
    <div class="section-header">
      <h2 class="section-header__title">{{ section.settings.title }}</h2>
    </div>
  {% endif %}

  <div class="grid grid--uniform{% unless section.settings.enable_gutter %} grid--no-gutters{% endunless %}">
    {% assign product_limit = section.settings.products_to_show %}
    
    {% case section.settings.per_row %}
      {% when 2 %}
        {%- assign grid_item_width = 'medium-up--one-half' -%}
        {%- assign image_size = '550x' -%}
      {% when 3 %}
        {%- assign grid_item_width = 'small--one-half medium-up--one-third' -%}
        {%- assign image_size = '350x' -%}
      {% when 4 %}
        {%- assign grid_item_width = 'small--one-half medium-up--one-quarter' -%}
        {%- assign image_size = '250x' -%}
      {% when 5 %}
        {%- assign grid_item_width = 'small--one-half medium-up--one-fifth' -%}
        {%- assign image_size = '200x' -%}
    {% endcase %}
    
    {% for product in collections.all.products limit: product_limit %}
      <div class="grid__item {{ grid_item_width }}">
        <div class="product-card">
          <a href="{{ product.url | within: collection }}" class="product-card__link">
            <div class="product-card__image-wrapper">
              {% if product.featured_image != blank %}
                <div class="product-card__image product-card__image--main">
                  <img class="lazyload"
                      data-src="{{ product.featured_image | img_url: image_size, crop: 'center' }}"
                      data-widths="[180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                      data-aspectratio="{{ product.featured_image.aspect_ratio }}"
                      data-sizes="auto"
                      alt="{{ product.featured_image.alt | escape }}">
                  <noscript>
                    <img src="{{ product.featured_image | img_url: image_size, crop: 'center' }}" alt="{{ product.featured_image.alt | escape }}">
                  </noscript>
                </div>
                
                {% if product.images.size > 1 and section.settings.enable_image_slideshow %}
                  <div class="product-card__image-slideshow" data-speed="{{ section.settings.slideshow_speed }}">
                    {% for image in product.images %}
                      <div class="product-card__image product-card__image--slide{% if forloop.first %} active{% endif %}">
                        <img class="lazyload"
                            data-src="{{ image | img_url: image_size, crop: 'center' }}"
                            data-widths="[180, 360, 540, 720, 900, 1080, 1296, 1512, 1728, 2048]"
                            data-aspectratio="{{ image.aspect_ratio }}"
                            data-sizes="auto"
                            alt="{{ image.alt | escape }}">
                        <noscript>
                          <img src="{{ image | img_url: image_size, crop: 'center' }}" alt="{{ image.alt | escape }}">
                        </noscript>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {% endif %}
            </div>
            
            <div class="product-card__info">
              <div class="product-card__name">{{ product.title }}</div>
              
              <div class="product-card__price">
                {% if product.compare_at_price > product.price %}
                  <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
                  <s class="product-card__regular-price">{{ product.compare_at_price | money }}</s>
                  <span class="visually-hidden">{{ 'products.general.sale_price' | t }}</span>
                  <span class="product-card__sale-price">{{ product.price | money }}</span>
                {% else %}
                  <span class="product-card__regular-price">{{ product.price | money }}</span>
                {% endif %}
              </div>
            </div>
          </a>
          
          {% if section.settings.show_add_to_cart %}
            {% if product.available %}
              <div class="product-card__add-to-cart">
                <form method="post" action="/cart/add">
                  <input type="hidden" name="id" value="{{ product.variants.first.id }}" />
                  <button type="submit" name="add" class="btn btn--full btn--add-to-cart">
                    <span>{{ 'products.product.add_to_cart' | t }}</span>
                  </button>
                </form>
              </div>
            {% else %}
              <div class="product-card__add-to-cart">
                <button class="btn btn--full btn--add-to-cart btn--sold-out" disabled>
                  <span>{{ 'products.product.sold_out' | t }}</span>
                </button>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  {% if section.settings.show_view_all %}
    <div class="view-all-button-container">
      <a href="/collections/all" class="btn {% if section.settings.view_all_style == 'secondary' %}btn--secondary{% endif %}">
        {{ section.settings.view_all_text }}
      </a>
    </div>
  {% endif %}
</div>

<style>
  .product-card {
    position: relative;
    margin-bottom: 30px;
    transition: box-shadow 0.3s;
  }

  .product-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .product-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-card__image-wrapper {
    position: relative;
    overflow: hidden;
    padding-bottom: 100%; /* 1:1 Aspect Ratio */
  }

  .product-card__image {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
  }

  .product-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Image slideshow styles */
  .product-card__image-slideshow {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  
  .product-card:hover .product-card__image-slideshow {
    opacity: 1;
    visibility: visible;
  }
  
  .product-card__image--slide {
    opacity: 0;
    transition: opacity 0.5s ease;
    visibility: hidden;
  }
  
  .product-card__image--slide.active {
    opacity: 1;
    visibility: visible;
  }
  
  /* Original image handling on hover */
  .product-card:hover .product-card__image--main {
    opacity: 0;
    visibility: hidden;
  }

  .product-card__info {
    padding: 15px 10px;
  }

  .product-card__name {
    font-weight: var(--font-weight-body);
    margin-bottom: 5px;
    color: var(--color-text);
    font-size: 14px;
    white-space: normal;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .product-card__price {
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .product-card__regular-price {
    color: var(--color-text);
  }

  .product-card__sale-price {
    color: var(--color-sale-text);
    margin-left: 5px;
  }

  .product-card__add-to-cart {
    margin-top: 10px;
    padding: 0 10px 10px;
  }

  .btn--add-to-cart {
    width: 100%;
    font-size: 13px;
    padding: 8px 10px;
    transition: background-color 0.2s;
  }

  .view-all-button-container {
    margin-top: 30px;
    text-align: center;
  }

  .btn--sold-out {
    background-color: var(--color-btn-sold-out-bg);
    color: var(--color-btn-sold-out-text);
    cursor: default;
  }

  @media screen and (max-width: 768px) {
    .product-card__name,
    .product-card__price {
      font-size: 13px;
    }
    
    .product-card__add-to-cart {
      padding: 0 8px 8px;
    }
    
    .btn--add-to-cart {
      font-size: 12px;
      padding: 6px 8px;
    }
    
    /* Hide slideshow on mobile since hover doesn't work well */
    .product-card__image-slideshow {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Find all product slideshows
    const slideshows = document.querySelectorAll('.product-card__image-slideshow');
    
    slideshows.forEach(function(slideshow) {
      // Get all slides in this slideshow
      const slides = slideshow.querySelectorAll('.product-card__image--slide');
      if (slides.length <= 1) return;
      
      // Get slideshow speed from data attribute (in milliseconds)
      const speed = parseInt(slideshow.getAttribute('data-speed')) || 1000;
      let currentSlide = 0;
      let slideshowInterval = null;
      
      function showSlide(n) {
        // Hide all slides
        slides.forEach(slide => slide.classList.remove('active'));
        
        // Show the current slide
        slides[n].classList.add('active');
      }
      
      function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
      }
      
      // Get the parent product card
      const productCard = slideshow.closest('.product-card');
      
      // Start slideshow on hover
      productCard.addEventListener('mouseenter', function() {
        // Reset to first slide
        currentSlide = 0;
        showSlide(currentSlide);
        
        // Start cycling through slides
        slideshowInterval = setInterval(nextSlide, speed);
      });
      
      // Stop slideshow when mouse leaves
      productCard.addEventListener('mouseleave', function() {
        if (slideshowInterval) {
          clearInterval(slideshowInterval);
          slideshowInterval = null;
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Featured Products Grid",
  "class": "index-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "All Products"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Number of products to show",
      "default": 8,
      "min": 4,
      "max": 24,
      "step": 4
    },
    {
      "type": "range",
      "id": "per_row",
      "label": "Products per row",
      "default": 4,
      "min": 2,
      "max": 5,
      "step": 1
    },
    {
      "type": "checkbox",
      "id": "enable_gutter",
      "label": "Add spacing between products",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show Add to Cart button",
      "default": true
    },
    {
      "type": "header",
      "content": "Product Image Slideshow"
    },
    {
      "type": "checkbox",
      "id": "enable_image_slideshow",
      "label": "Enable image slideshow on hover",
      "default": true
    },
    {
      "type": "range",
      "id": "slideshow_speed",
      "label": "Change image every (milliseconds)",
      "min": 1000,
      "max": 5000,
      "step": 500,
      "default": 1500,
      "info": "1000 milliseconds = 1 second"
    },
    {
      "type": "header",
      "content": "View All Button"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View All' button",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "Button text",
      "default": "View All Products"
    },
    {
      "type": "select",
      "id": "view_all_style",
      "label": "Button style",
      "default": "primary",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Featured Products Grid",
      "category": "Product"
    }
  ]
}
{% endschema %}